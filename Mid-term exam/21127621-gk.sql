--Mã đề: 3
--Mã lớp: 21CLC1
--MSSV: 21127621
--Vị trí: cột 5 hàng 5

DROP DATABASE QLBenhNhan
CREATE DATABASE QLBenhNhan
USE QLBenhNhan

CREATE TABLE BENHNHAN
(
	MSBN char(5),
	BENHVIEN char(5),
	HOTEN nvarchar(30),
	DIACHI nvarchar(50),
	NGAYSINH date,
	BACSI char(4),

	PRIMARY KEY (MSBN,BENHVIEN)
)

CREATE TABLE THUOC
(
	MATHUOC char(3),
	TENTHUOC nvarchar(30),
	CHANTRI nvarchar(30),
	THUOCDC char(3),
	DONGIA int,
	SOLUONG int,

	PRIMARY KEY (MATHUOC)
)

ALTER TABLE THUOC
ADD CONSTRAINT FK_THUOC
FOREIGN KEY (THUOCDC)
REFERENCES THUOC(MATHUOC)

CREATE TABLE TOATHUOC
(
	IDBENHNHAN char(5),
	MATHUOC char(3),
	SOLUONG int,
	NGAYCAP date,
	IDBENHVIEN char(5),
	BACSI char(4),

	PRIMARY KEY (IDBENHNHAN, MATHUOC, IDBENHVIEN)
)

ALTER TABLE TOATHUOC
ADD CONSTRAINT FK_TOATHUOC_BENHNHAN
FOREIGN KEY (IDBENHNHAN,IDBENHVIEN)
REFERENCES BENHNHAN(MSBN,BENHVIEN)

ALTER TABLE TOATHUOC
ADD CONSTRAINT FK_TOATHUOC_THUOC
FOREIGN KEY (MATHUOC)
REFERENCES THUOC(MATHUOC)

INSERT INTO BENHNHAN VALUES
('BN001', '79012', N'Trần Thị Bé',N'31 Nguyễn Xí Q.Bình Thạnh','1978/1/21','BS01'),
('BN002', '79013', N'Nguyễn Minh Tâm',N'2 Trần Hưng Đạo Q5','1960/1/22','BS01'),
('BN003', '79013', N'Trần Văn Lí',N'30 Hà Tồn Quyền Q5 ','1992/1/1','BS02'),
('BN002', '79016', N'Nguyễn Thu Sương',N'22 Nguyễn Thái Sơn Vũng Tàu ',NULL,'BS02')

INSERT INTO THUOC VALUES
('001', 'Paracetamol', N'Đặt trực tràng ',NULL,2000,340),
('002', 'Halothan', N'Đường hô hấp  ',NULL,3500,230),
('003', N'Oxygen dược dụng', N'Đường hô hấp  ',NULL,800,100)

UPDATE THUOC SET THUOCDC = '003' WHERE MATHUOC = '002'

INSERT INTO TOATHUOC VALUES
('BN001','001',10,'2000/11/30','79012', 'BS01'),
('BN002','003',20,'2000/2/12','79016', 'BS01')

INSERT INTO TOATHUOC VALUES
('BN002','001',15,'2023/2/13','79013', 'BS02'),
('BN002','002',15,'2023/2/13','79013', 'BS01')

SELECT BN.HOTEN,T.*
FROM THUOC AS T, BENHNHAN AS BN, TOATHUOC AS TT
WHERE TT.IDBENHNHAN = BN.MSBN AND T.MATHUOC = TT.MATHUOC AND CHARINDEX ('Q5', BN.DIACHI) !=0 AND datediff (y,2023,YEAR(TT.NGAYCAP))=0

SELECT  BN.HOTEN, TT.MATHUOC, SUM (T.DONGIA * TT.SOLUONG) AS THANHTIEN
FROM BENHNHAN AS BN, TOATHUOC AS TT, THUOC AS T
WHERE TT.IDBENHNHAN = BN.MSBN AND T.MATHUOC = TT.MATHUOC AND TT.IDBENHVIEN = BN.BENHVIEN
GROUP BY BN.HOTEN, BN.BENHVIEN, TT.MATHUOC

