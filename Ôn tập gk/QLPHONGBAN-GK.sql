DROP DATABASE QLPhongBanGK
CREATE DATABASE QLPhongBanGK
USE QLPhongBanGK

CREATE TABLE PHONGBAN
(
	MAPHONGBAN char(4),
	TENPHONGBAN nvarchar(30),
	DIADIEM char(4),
	TRUONGPHONG char(4),

	PRIMARY KEY (MAPHONGBAN)
)

CREATE TABLE NHANVIEN
(	
	MANV char(4),
	MAPHONG char(4),
	HOTEN nvarchar(30),
	NGAYSINH date,
	GIOITINH nvarchar(4),
	LUONG int,

	PRIMARY KEY (MANV, MAPHONG)
)

ALTER TABLE NHANVIEN
ADD CONSTRAINT FK_NHANVIEN_PHONGBAN
FOREIGN KEY (MAPHONG)
REFERENCES PHONGBAN(MAPHONGBAN)

ALTER TABLE PHONGBAN
ADD CONSTRAINT FK_PHONGBAN_NHANVIEN
FOREIGN KEY (TRUONGPHONG, MAPHONGBAN)
REFERENCES NHANVIEN(MANV, MAPHONG)

CREATE TABLE DEAN
(
	MADEAN char(4),
	TENDEAN nvarchar(30),
	THOIGIAN int,
	MAPHONGBAN char(4),
	TRUONGDEAN char(4),

	PRIMARY KEY (MADEAN),
)

ALTER TABLE DEAN
ADD CONSTRAINT FK_DEAN_NHANVIEN
FOREIGN KEY (TRUONGDEAN,MAPHONGBAN)
REFERENCES NHANVIEN(MANV,MAPHONG)


INSERT INTO PHONGBAN VALUES 
('P001', N'Nghiên cứu', 'C444',NULL),
('P002', N'Kế hoạch', 'B234',NULL),
('P003', N'Nhân sự', 'D111',NULL)

INSERT INTO NHANVIEN VALUES 
('NV01', 'P001', N'Trần Hải','1999/2/12', 'Nam',2500),
('NV02', 'P001', N'Lê Anh Đào','1987/12/30', N'Nữ',3000),
('NV01', 'P002', N'Lý Khanh','1960/6/6', 'Nam',1000),
('NV02', 'P002', N'Phan Minh Trí','1960/6/6', 'Nam',2500),
('NV03', 'P002', N'Nguyễn Lan','1982/3/7', N'Nữ',3000),
('NV01', 'P003', N'Vũ Bình Phương','1980/3/17', 'Nam',3000),
('NV02', 'P003', N'Đặng Khải Minh','1980/10/22', 'Nam',1400)

UPDATE PHONGBAN SET TRUONGPHONG = 'NV02' WHERE MAPHONGBAN = 'P001'
UPDATE PHONGBAN SET TRUONGPHONG = 'NV03' WHERE MAPHONGBAN = 'P002'
UPDATE PHONGBAN SET TRUONGPHONG = 'NV01' WHERE MAPHONGBAN = 'P003'

INSERT INTO DEAN VALUES
('DA01',N'Ngôi nhà thông minh',120,'P001', 'NV02'),
('DA02',N'Hành tinh xanh',220,'P002', 'NV01'),
('DA03',N'Công viên xanh',100,'P002', 'NV02')

SELECT DISTINCT NV.MANV, NV.HOTEN
FROM NHANVIEN AS NV, DEAN AS DA, PHONGBAN AS PB
WHERE NV.MANV = PB.TRUONGPHONG AND  NV.MANV = DA.TRUONGDEAN AND PB.MAPHONGBAN = NV.MAPHONG

SELECT PB.MAPHONGBAN,PB.TENPHONGBAN,PB.TRUONGPHONG, COUNT (*) AS SOLUONGNHANVIEN
FROM NHANVIEN AS NV, PHONGBAN AS PB
WHERE NV.MAPHONG = PB.MAPHONGBAN
GROUP BY PB.MAPHONGBAN,PB.TENPHONGBAN,PB.TRUONGPHONG

SELECT PB.MAPHONGBAN,PB.TENPHONGBAN
FROM PHONGBAN AS PB, DEAN AS DA
WHERE DA.MAPHONGBAN = PB.MAPHONGBAN
GROUP BY PB.MAPHONGBAN,PB.TENPHONGBAN
HAVING COUNT(*) >= 2