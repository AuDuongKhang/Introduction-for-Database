DROP DATABASE QLLopHocGK
CREATE DATABASE QLLopHocGK
USE QLLopHocGK

CREATE TABLE TRUONG
(
	MATRUONG char(4),
	TENTRUONG nvarchar (30),
	DIACHI nvarchar(50),
	NAMTHANHLAP int,
	CHIDOANTRUONG char(4),

	PRIMARY KEY (MATRUONG)
)

CREATE TABLE HOCSINH
(
	MAHS char(4),
	MATRUONG char(4),
	HOTEN nvarchar(30),
	NGAYSINH date,
	GIOITINH nvarchar(4),
	MALOP char(5),

	PRIMARY KEY (MAHS, MATRUONG)
)

ALTER TABLE HOCSINH
ADD CONSTRAINT FK_HOCSINH_TRUONG
FOREIGN KEY (MATRUONG)
REFERENCES TRUONG(MATRUONG)

ALTER TABLE TRUONG
ADD CONSTRAINT FK_TRUONG_HOCSINH
FOREIGN KEY (CHIDOANTRUONG, MATRUONG)
REFERENCES HOCSINH(MAHS, MATRUONG)

CREATE TABLE LOPHOC
(
	MALOP char(5),
	TENLOP nvarchar(30),
	GVCN nvarchar(30),
	MATRUONG char(4),
	LOPTRUONG char(4),

	PRIMARY KEY (MALOP)
)

ALTER TABLE HOCSINH
ADD CONSTRAINT FK_HOCSINH_LOPHOC
FOREIGN KEY (MALOP)
REFERENCES LOPHOC(MALOP)

ALTER TABLE LOPHOC
ADD CONSTRAINT FK_LOPHOC_HOCSINH
FOREIGN KEY (LOPTRUONG, MATRUONG)
REFERENCES HOCSINH(MAHS, MATRUONG)

INSERT INTO TRUONG VALUES 
('TR01', N'Lê Hồng Phong', N'225 Nguyễn Văn Cừ, Quận 5, TP.HCM', 1995,NULL),
('TR02', N'Lê Quý Đôn', N'125 Lê Quý Đôn, Quận 3, TP.HCM', 1993,NULL)

INSERT INTO HOCSINH VALUES 
('HS01', 'TR01', N'Trần Hải','1999/2/12','Nam', NULL),
('HS02', 'TR01', N'Lê Anh Đào','1987/12/30',N'Nữ', NULL),
('HS03', 'TR01', N'Lý Khanh','1960/6/6','Nam', NULL),
('HS04', 'TR01', N'Phan Minh Trí','1960/6/6','Nam', NULL),
('HS01', 'TR02', N'Nguyễn Lan','1982/3/7',N'Nữ', NULL),
('HS02', 'TR02', N'Vũ Bình Phương','1980/3/17','Nam', NULL),
('HS03', 'TR02', N'Đặng Khải Minh ','1980/10/22','Nam', NULL)

UPDATE TRUONG SET CHIDOANTRUONG = 'HS01' WHERE MATRUONG = 'TR01'
UPDATE TRUONG SET CHIDOANTRUONG = 'HS01' WHERE MATRUONG = 'TR02'

INSERT INTO LOPHOC VALUES
('LA001',N'10 chuyên Toán', N'Vương Hải', 'TR01','HS02'),
('LA002',N'10 chuyên Văn', N'Nguyễn Hồng Hạnh', 'TR01','HS03'),
('LA003',N'10 chuyên Anh', N'Trần Trung Trí', 'TR02','HS01')

SELECT LH.MALOP, LH.TENLOP
FROM HOCSINH AS HS, LOPHOC AS LH
WHERE LH.LOPTRUONG = HS.MAHS AND CHARINDEX (N'Nguyễn',HS.HOTEN)!=0

SELECT HS.MATRUONG, T.TENTRUONG, COUNT (*) AS SOLUONGHS
FROM TRUONG AS T, HOCSINH AS HS
WHERE T.MATRUONG = HS.MATRUONG
GROUP BY HS.MATRUONG, T.TENTRUONG

SELECT HS.MAHS, HS.HOTEN
FROM TRUONG AS T, HOCSINH AS HS, LOPHOC AS LH
WHERE T.CHIDOANTRUONG = HS.MAHS AND T.MATRUONG = LH.MATRUONG AND HS.MATRUONG = T.MATRUONG
GROUP BY HS.MAHS, HS.HOTEN
HAVING COUNT (LH.MALOP) >=2

SELECT *
FROM TRUONG AS T, HOCSINH AS HS
WHERE T.MATRUONG = HS.MATRUONG
